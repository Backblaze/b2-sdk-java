# Copyright 2022, Backblaze Inc. All Rights Reserved.
# License https://www.backblaze.com/using_b2_code.html

name: b2-sdk-java ci/cd

on:
  push:
  pull_request:
    branches:
    - master

env:
  PYTHON_DEFAULT_VERSION: 3.8
  OUTPUT_DIR: $GITHUB_WORKSPACE/build/outputs
  OUTPUT_ZIP: b2-sdk-build-${GITHUB_RUN_NUMBER}.zip
  BUILD_NUMBER: ${{ github.run_number }}
  # These are stored in Bitwarden
  B2_ACCOUNT_ID: ${{ secrets.B2_ACCOUNT_ID }}
  B2_UPLOAD_BUCKET: ${{ secrets.B2_UPLOAD_BUCKET }}
  B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - uses: gradle/actions/wrapper-validation@v4
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set up Python ${{ env.PYTHON_DEFAULT_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install dependencies
        run: |
          # upgrade pip and setuptools so that b2 CLI can be properly installed
          python -m pip install --upgrade pip setuptools
          python -m pip install b2

      - name: Build the distribution
        run: |
          $GITHUB_WORKSPACE/gradlew build
          #
          # Prepare the outputs
          #

          # make the directory
          mkdir -p ${{ env.OUTPUT_DIR }}
          cp -v */build/libs/b2-sdk-*.{jar,pom,module} ${{ env.OUTPUT_DIR }}

          # zip up the outputs
          cd ${{ env.OUTPUT_DIR }}
          zip -r $GITHUB_WORKSPACE/build/${{ env.OUTPUT_ZIP }} *

      - name: Deploy to internal Maven repo
        if: github.ref == 'refs/heads/master' && github.repository == 'Backblaze/b2-sdk-java-private'
        run: $GITHUB_WORKSPACE/gradlew publishMavenPublicationToBzArtifactoryRepository publishMavenPublicationToBzGithubPackagesRepository
        env:
          ORG_GRADLE_PROJECT_bzArtifactoryUsername: ${{ secrets.ARTIFACTORY_USERNAME }}
          ORG_GRADLE_PROJECT_bzArtifactoryPassword: ${{ secrets.ARTIFACTORY_TOKEN }}
          ORG_GRADLE_PROJECT_bzGithubPackagesUsername: ${{ secrets.PACKAGES_USERNAME }}
          ORG_GRADLE_PROJECT_bzGithubPackagesPassword: ${{ secrets.PACKAGES_TOKEN }}

      - name: Upload to b2
        if: github.ref == 'refs/heads/master'
        # upload to b2 (if credentials are provided, as they will be for backblaze's builds, but not pull requests)
        # This should be using python 3.4
        run: $GITHUB_WORKSPACE/maybe_upload_build_results ${{ env.OUTPUT_ZIP }}

      - name: Check GitHub Pages status
        if: github.ref == 'refs/heads/master'
        uses: crazy-max/ghaction-github-status@v4
        with:
          pages_threshold: major_outage

      - name: Deploy Javadoc
        # note that i'm only uploading the javadocs for b2-sdk-core.
        # that's because i'm lame and building separate javadocs for
        # each jar and only uploading one set of javadocs.
        if: github.ref == 'refs/heads/master' && success()
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: gh-pages
          build_dir: core/build/docs/javadoc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
